<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="text-dark mb-0">Pedido #<%= order.order_number %></h2>
        <small class="text-muted">
            Criado em <%= new Date(order.created_at).toLocaleDateString('pt-BR') %> às 
            <%= new Date(order.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) %>
        </small>
    </div>
    <div class="d-flex gap-2">
        <a href="/admin/pedidos" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Voltar
        </a>
        <button class="btn btn-outline-primary" onclick="window.print()">
            <i class="fas fa-print me-1"></i>
            Imprimir
        </button>
    </div>
</div>

<div class="row">
    <!-- Order Details -->
    <div class="col-lg-8">
        <!-- Order Status -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Status do Pedido
                </h6>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <% 
                            let statusClass = 'secondary';
                            let statusText = order.status;
                            let statusIcon = 'fas fa-circle';
                            
                            switch(order.status) {
                                case 'pending': 
                                    statusClass = 'warning'; 
                                    statusText = 'Pendente'; 
                                    statusIcon = 'fas fa-clock';
                                    break;
                                case 'processing': 
                                    statusClass = 'info'; 
                                    statusText = 'Processando'; 
                                    statusIcon = 'fas fa-cog fa-spin';
                                    break;
                                case 'shipped': 
                                    statusClass = 'primary'; 
                                    statusText = 'Enviado'; 
                                    statusIcon = 'fas fa-shipping-fast';
                                    break;
                                case 'delivered': 
                                    statusClass = 'success'; 
                                    statusText = 'Entregue'; 
                                    statusIcon = 'fas fa-check-circle';
                                    break;
                                case 'cancelled': 
                                    statusClass = 'danger'; 
                                    statusText = 'Cancelado'; 
                                    statusIcon = 'fas fa-times-circle';
                                    break;
                            }
                            %>
                            <div class="me-3">
                                <i class="<%= statusIcon %> fa-2x text-<%= statusClass %>"></i>
                            </div>
                            <div>
                                <h5 class="mb-1 text-<%= statusClass %>"><%= statusText %></h5>
                                <small class="text-muted">Status atual do pedido</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <form method="POST" action="/admin/pedidos/<%= order.id %>/status" class="d-flex">
                            <select name="status" class="form-select me-2">
                                <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pendente</option>
                                <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processando</option>
                                <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Enviado</option>
                                <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Entregue</option>
                                <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelado</option>
                            </select>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-shopping-bag me-2"></i>
                    Itens do Pedido
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Produto</th>
                                <th class="text-center">Quantidade</th>
                                <th class="text-end">Preço Unit.</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% items.forEach(item => { %>
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <!-- Product image placeholder -->
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            </div>
                                            <div>
                                                <strong><%= item.product_name %></strong>
                                                <% if (item.variant_name) { %>
                                                    <br>
                                                    <small class="text-muted">
                                                        <%= item.variant_name %>
                                                    </small>
                                                <% } %>
                                                <% if (item.product_slug) { %>
                                                    <br>
                                                    <a href="/produtos/<%= item.product_slug %>" 
                                                       target="_blank" 
                                                       class="small text-primary">
                                                        <i class="fas fa-external-link-alt me-1"></i>
                                                        Ver produto
                                                    </a>
                                                <% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">
                                            <%= item.quantity %>
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        R$ <%= parseFloat(item.price).toFixed(2).replace('.', ',') %>
                                    </td>
                                    <td class="text-end">
                                        <strong>R$ <%= (parseFloat(item.price) * item.quantity).toFixed(2).replace('.', ',') %></strong>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                                <td class="text-end"><strong>R$ <%= parseFloat(order.subtotal).toFixed(2).replace('.', ',') %></strong></td>
                            </tr>
                            <% if (order.shipping_cost > 0) { %>
                                <tr>
                                    <td colspan="3" class="text-end">Frete:</td>
                                    <td class="text-end">R$ <%= parseFloat(order.shipping_cost).toFixed(2).replace('.', ',') %></td>
                                </tr>
                            <% } %>
                            <tr>
                                <td colspan="3" class="text-end"><h5 class="mb-0">Total:</h5></td>
                                <td class="text-end"><h5 class="mb-0 text-primary">R$ <%= parseFloat(order.total).toFixed(2).replace('.', ',') %></h5></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Sidebar -->
    <div class="col-lg-4">
        <!-- Customer Information -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    Informações do Cliente
                </h6>
            </div>
            <div class="card-body">
                <% if (order.user_name) { %>
                    <div class="mb-3">
                        <strong><%= order.user_name %></strong>
                        <% if (order.user_email) { %>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-envelope me-1"></i>
                                <a href="mailto:<%= order.user_email %>"><%= order.user_email %></a>
                            </small>
                        <% } %>
                        <% if (order.user_phone) { %>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-phone me-1"></i>
                                <a href="tel:<%= order.user_phone %>"><%= order.user_phone %></a>
                            </small>
                        <% } %>
                    </div>
                <% } else { %>
                    <div class="text-muted">
                        <i class="fas fa-user-secret me-2"></i>
                        Cliente visitante
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-credit-card me-2"></i>
                    Pagamento
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Método:</strong>
                    <span class="ms-2">
                        <% if (order.payment_method) { %>
                            <%= order.payment_method.toUpperCase() %>
                        <% } else { %>
                            Não informado
                        <% } %>
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Status:</strong>
                    <% 
                    let paymentClass = 'secondary';
                    let paymentText = order.payment_status || 'pending';
                    
                    switch(order.payment_status) {
                        case 'pending': 
                            paymentClass = 'warning'; 
                            paymentText = 'Pendente'; 
                            break;
                        case 'paid': 
                            paymentClass = 'success'; 
                            paymentText = 'Pago'; 
                            break;
                        case 'failed': 
                            paymentClass = 'danger'; 
                            paymentText = 'Falhou'; 
                            break;
                        case 'refunded': 
                            paymentClass = 'info'; 
                            paymentText = 'Reembolsado'; 
                            break;
                    }
                    %>
                    <span class="badge bg-<%= paymentClass %> ms-2">
                        <%= paymentText %>
                    </span>
                </div>
                <div>
                    <strong>Total:</strong>
                    <span class="ms-2 text-primary fw-bold">
                        R$ <%= parseFloat(order.total).toFixed(2).replace('.', ',') %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Shipping Information -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-shipping-fast me-2"></i>
                    Entrega
                </h6>
            </div>
            <div class="card-body">
                <% if (order.shipping_address) { %>
                    <div class="mb-2">
                        <strong>Endereço:</strong>
                        <div class="mt-1">
                            <%= order.shipping_address %>
                        </div>
                    </div>
                <% } %>
                <div class="mb-2">
                    <strong>Custo do frete:</strong>
                    <span class="ms-2">
                        <% if (order.shipping_cost > 0) { %>
                            R$ <%= parseFloat(order.shipping_cost).toFixed(2).replace('.', ',') %>
                        <% } else { %>
                            <span class="text-success">Grátis</span>
                        <% } %>
                    </span>
                </div>
            </div>
        </div>

        <!-- Order Notes -->
        <% if (order.notes) { %>
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-sticky-note me-2"></i>
                        Observações
                    </h6>
                </div>
                <div class="card-body">
                    <%= order.notes %>
                </div>
            </div>
        <% } %>

        <!-- Order Timeline -->
        <div class="card border-0 shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Histórico
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <h6 class="mb-1">Pedido criado</h6>
                            <small class="text-muted">
                                <%= new Date(order.created_at).toLocaleString('pt-BR') %>
                            </small>
                        </div>
                    </div>
                    
                    <% if (order.status !== 'pending') { %>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Em processamento</h6>
                                <small class="text-muted">Status atualizado</small>
                            </div>
                        </div>
                    <% } %>
                    
                    <% if (order.status === 'shipped' || order.status === 'delivered') { %>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Pedido enviado</h6>
                                <small class="text-muted">Em transporte</small>
                            </div>
                        </div>
                    <% } %>
                    
                    <% if (order.status === 'delivered') { %>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Pedido entregue</h6>
                                <small class="text-muted">Concluído</small>
                            </div>
                        </div>
                    <% } %>
                    
                    <% if (order.status === 'cancelled') { %>
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Pedido cancelado</h6>
                                <small class="text-muted">Processo interrompido</small>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content h6 {
    margin-bottom: 4px;
    font-size: 0.9rem;
}

.timeline-content small {
    font-size: 0.8rem;
}

@media print {
    .btn, .card-header {
        display: none !important;
    }
    
    .card {
        border: 1px solid #dee2e6 !important;
    }
}

.fa-spin {
    animation: fa-spin 2s infinite linear;
}

@keyframes fa-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
